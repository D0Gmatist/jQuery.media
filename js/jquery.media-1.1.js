/**
 * $media jQuery plugin (v.1.1)
 *
 * 2011. Created by Oscar Otero (http://oscarotero.com / http://anavallasuiza.com)
 *
 * $media is released under the GNU Affero GPL version 3.
 * More information at http://www.gnu.org/licenses/agpl-3.0.html
 */

(function(a){var b=navigator.userAgent.toLowerCase();if(b.match(/(iphone|ipod|ipad)/)){b="ios"}else{b="browser"}window.$media=function(b){this.element=b;this.$element=a(b);this.isFullScreen=false;if(this.$element.is("video")){this.type="video"}else if(this.$element.is("audio")){this.type="audio"}this.totalTime(function(){var a=this.source();this.fragment(a.substring(a.lastIndexOf("#")+1).toLowerCase())})};$media.plugins={};$media.prototype.fragment=function(b){if(b==undefined){return this.$element.data("fragments")}var c={};if(typeof b=="string"){var d=b.split("&");var b={};a.each(d,function(a,c){c=c.split("=",2);b[c[0]]=c[1]})}if(typeof b!="object"){console.error("The specified fragment is not valid");return this}a.each(b,function(a,b){switch(a){case"t":if(typeof b=="string"){var d=b.match(/^(npt|smpte)/gi);var e=b.replace(/^(npt:|smpte[^:]+:)/,"").split(",",2);c.t={format:d?d[0]:"npt",start:e[0].toSeconds(),end:e[1].toSeconds()}}else{c.t=b;if(!c.t.format){c.t.format="npt"}}break;case"track":case"id":c.track=b;break;case"xywh":if(typeof b=="string"){var d=b.match(/^(pixel|percent)/gi);var f=b.replace(/^(pixel:|percent:)/,"").split(",",4);c.xywh={format:d?d[0]:"pixel",x:f[0],y:f[1],w:f[2],h:f[3]}}else{c.xywh=b;if(!c.xywh.format){c.xywh.format="pixel"}}break}});if(c.t){this.totalTime(function(){this.seek(c.t.start)})}this.$element.data("fragments",c);return this};$media.prototype.canPlay=function(a){if(!this.element.canPlayType){return false}if(a==undefined){if(this.source()){a=this.source();return this.canPlay(a.substring(a.lastIndexOf(".")+1).toLowerCase().split("#",2)[0])}a=this.sources();var b=a.length;var c=0;for(var d=0;d<b;d++){var e=this.canPlay(a[d].substring(a[d].lastIndexOf(".")+1).toLowerCase().split("#",2)[0]);c=e>c?e:c}return c}var f=a;if(/^[a-z0-9]+$/i.test(f)){f=this.mimeType(f)}switch(this.element.canPlayType(f)){case"probably":return 2;case"maybe":return 1}return 0};$media.prototype.mimeType=function(a){switch(a){case"mp4":case"acc":return this.type+"/mp4";case"ogg":case"ogv":return this.type+"/ogg";case"webm":return this.type+"/webm";case"mp3":return this.type+"/mpeg";case"wav":return this.type+"/wav"}};$media.prototype.sources=function(b,c){var d=this.$element;if(b==undefined){var e=[];if(d.attr("src")){e.push(d.attr("src"))}d.find("source").each(function(){e.push(a(this).attr("src"))});return e}d.find("source").remove();if(typeof b=="string"){d.attr("src",b)}else{if(!a.isArray(b)){b=[b]}d.removeAttr("src");var f=this;a.each(b,function(b,c){if(typeof c!="object"){c={src:c}}if(!c.type){var e=c.src.substring(c.src.lastIndexOf(".")+1).toLowerCase().split("#",2)[0];c.type=f.mimeType(e)}a("<source>",c).appendTo(d)})}if(c!==false){this.element.load()}this.totalTime(function(){var a=this.source();this.fragment(a.substring(a.lastIndexOf("#")+1).toLowerCase())});return this};$media.prototype.source=function(){return this.element.currentSrc};$media.prototype.attr=function(a,b){if(a=="src"||a=="sources"){return this.sources(b)}if(b==undefined){return this.$element.attr(a)}this.$element.attr(a,b);return this};$media.prototype.prop=function(a,b){if(b==undefined){return this.$element.prop(a)}this.$element.prop(a,b);return this};$media.prototype.width=function(a){if(a===true){return this.element.videoWidth}if(a==undefined){return this.$element.width()}this.$element.width(a);return this};$media.prototype.height=function(a){if(a===true){return this.element.videoHeight}if(a==undefined){return this.$element.height()}this.$element.height(a);return this};$media.prototype.play=function(b,c){if(a.isFunction(b)){this.bind("mediaPlay",b,c)}else if(this.element.paused){this.element.play()}return this};$media.prototype.fullScreen=function(b,c){if(a.isFunction(b)){this.bind("mediaFullScreen",b,c);return this}if(b===false){if(a.isFunction(document.webkitCancelFullScreen)){document.webkitCancelFullScreen()}else if(a.isFunction(document.mozCancelFullScreen)){document.mozCancelFullScreen()}}else if(b===true){if(a.isFunction(this.element.webkitRequestFullScreen)){this.element.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}else if(a.isFunction(this.element.mozRequestFullScreen)){this.element.mozRequestFullScreen()}}else{if(document.mozFullScreen||document.webkitIsFullScreen){this.fullScreen(false)}else{this.fullScreen(true)}}return this};$media.prototype.playing=function(b,c){if(a.isFunction(b)){this.bind("mediaPlaying",b,c);return this}return this.element.paused||this.element.ended?false:true};$media.prototype.waiting=function(b,c){if(a.isFunction(b)){this.bind("mediaWaiting",b,c);return this}return this.element.readyState>2?false:true};$media.prototype.pause=function(b,c){if(a.isFunction(b)){this.bind("mediaPause",b,c)}else if(!this.element.paused){this.element.pause()}return this};$media.prototype.playPause=function(b,c){if(a.isFunction(b)){this.bind("mediaPlayPause",b,c)}else{if(this.element.paused){this.play()}else{this.pause()}this.trigger("mediaPlayPause",[this.time(),this.element.paused])}return this};$media.prototype.stop=function(b,c){if(a.isFunction(b)){this.bind("mediaStop",b,c)}else{this.pause().reload();this.trigger("mediaStop",[this.time()])}return this};$media.prototype.end=function(b,c){if(a.isFunction(b)){this.bind("mediaEnd",b,c)}else{this.pause().seek(this.element.duration)}return this};$media.prototype.remove=function(b){if(a.isFunction(b)){this.bind("mediaRemove",b);return this}this.trigger("mediaRemove");this.$element.remove();for(prop in this){if(this.hasOwnProperty(prop)){this[prop]={}}}};$media.prototype.seek=function(b,c){if(a.isFunction(b)){this.bind("mediaSeek",b,c)}else{this.ready(1,function(){var a=this.seekPoint(b)||this.time(b);if(this.element.currentTime!=a){this.element.currentTime=a}})}return this};$media.prototype.seekPoint=function(a,b){var c=this.$element.data("seek_points")||{};if(b==undefined){return c[a]}c[a]=this.time(b);this.$element.data("seek_points",c);return this};$media.prototype.seeking=function(b,c){if(a.isFunction(b)){this.bind("mediaSeeking",b,c);return this}return this.element.seeking};$media.prototype.volume=function(c,d){if(b=="ios"){return this}if(c==undefined){return Math.round(this.element.volume*100)}if(a.isFunction(c)){this.bind("mediaVolume",c,d)}else{this.element.volume=parseInt(c)/100}return this};$media.prototype.changingVolume=function(b,c){if(a.isFunction(b)){this.bind("mediaChangingVolume",b,c)}return this};$media.prototype.mute=function(c,d){if(b=="ios"){return this}if(a.isFunction(c)){this.bind("mediaMute",c,d)}else{if(typeof c=="boolean"){this.element.muted=c}else{this.element.muted=this.element.muted?false:true}this.trigger("mediaMute",[this.element.muted])}return this};$media.prototype.bind=function(b,c,d){var e=this.$element.data("events");e=e&&e[b]?true:false;if(d){this.$element.one(b,a.proxy(c,this))}else{this.$element.bind(b,a.proxy(c,this))}if(e){return this}var f=this;switch(b){case"mediaFullScreen":this.bind("mozfullscreenchange",function(a){this.trigger("mediaFullScreen",[true]);this.isFullScreen=true});a(document).bind("mozfullscreenchange",function(a){if(document.mozFullScreen===false&&f.isFullScreen){f.trigger("mediaFullScreen",[false]);f.isFullScreen=false}});this.bind("webkitfullscreenchange",function(a){this.trigger("mediaFullScreen",[document.webkitIsFullScreen]);this.isFullScreen=true});break;case"mediaEnd":this.bind("ended",function(){this.trigger("mediaEnd",[this.time()])});break;case"mediaPause":this.bind("pause",function(){this.trigger("mediaPause",[this.time()])});break;case"mediaWaiting":this.bind("waiting",function(){this.trigger("mediaWaiting",[this.time()])});break;case"mediaPlay":this.bind("play",function(){this.trigger("mediaPlay",[this.time()])});break;case"mediaPlaying":this.bind("timeupdate",function(){if(this.playing()){this.trigger("mediaPlaying",[this.time()])}});break;case"mediaSeek":case"mediaSeeking":var g;var h=function(){f.trigger("mediaSeek",[f.time()])};this.bind("seeked seeking",function(){clearTimeout(g);g=setTimeout(h,500);this.trigger("mediaSeeking",[this.time()])});break;case"mediaVolume":case"mediaChangingVolume":var i;var j=function(){f.trigger("mediaVolume",[f.volume()])};this.bind("volumechange",function(){clearTimeout(i);i=setTimeout(j,500);this.trigger("mediaChangingVolume",[this.volume()])});break}return this};$media.prototype.trigger=function(a,b){this.$element.trigger(a,b);return this};$media.prototype.time=function(a){if(a==undefined){return this.element.currentTime.toSeconds()}if(isNaN(parseInt(a))){return 0}a=""+a;var b=0;if(a.indexOf("+")===0||a.indexOf("-")===0){var c=a.substr(1).toSeconds();if(a.indexOf("-")===0){c=-c}if(a.indexOf("%")==-1){b=c+this.element.currentTime.toSeconds()}else{b=Math.round(this.totalTime()/100*parseInt(c))+this.element.currentTime.toSeconds()}}else if(a.indexOf("%")!=-1){b=Math.round(this.totalTime()/100*a.toSeconds())}else{b=a.toSeconds()}if(b<0){b=0}else if(b>this.totalTime()){b=this.totalTime()}return b};$media.prototype.totalTime=function(b){if(!a.isFunction(b)){return this.element.duration.toSeconds()}return this.ready(1,function(){a.proxy(b,this)(this.element.duration.toSeconds())})};$media.prototype.ready=function(b,c){if(typeof b!="number"){c=b;b=3}if(!a.isFunction(c)){return this.element.readyState<b?false:true}if(this.element.readyState>=b){a.proxy(c,this)()}else{var d=this;setTimeout(function(){d.ready(b,c)},13)}return this};$media.prototype.reload=function(){this.sources(this.sources());return this};$media.prototype.extend=function(b,c){if(typeof b!="object"){var d=b;b={};b[d]=c}a.extend(this,b)};$media.extend=function(b,c){if(typeof b!="object"){var d=b;b={};b[d]=c}a.each(b,function(a,b){$media.prototype[a]=b})};$media.prototype.addPlugin=function(b,c){var d=b;if(typeof d!="object"){d={};d[b]=c}var e=this;a.each(d,function(a,b){if(!$media.plugins[a]){console.error('The plugin "'+a+'" is not registered');return false}e[a]=new $media.plugins[a](e,b)});return this};jQuery.media=function(b,c){if(c){if(c.src){var d=c.src;delete c.src}b=a(b,c);var e=new $media(b.get(0));if(d){e.sources(d)}return e}b=a(b);if(!b.is("video, audio")){b=b.find("video, audio")}return new $media(b.get(0))};jQuery.mediaVideo=function(b){if(typeof b=="string"){b={src:b}}return a.media("<video>",b)};jQuery.mediaAudio=function(b){if(typeof b=="string"){b={src:b}}return a.media("<audio>",b)}})(jQuery);String.prototype.toSeconds=function(){var a=this;if(/^([0-9]{1,2}:)?[0-9]{1,2}:[0-9]{1,2}(\.[0-9]+)?(,[0-9]+)?$/.test(a)){a=a.split(":",3);if(a.length==3){var b=a[2].split(",",2);b[1]=b[1]?b[1]:0;return((parseInt(a[0],10)*3600+parseInt(a[1],10)*60+parseFloat(b[0]))*1e3+parseInt(b[1],10))/1e3}var b=a[1].split(",",1);b[1]=b[1]?b[1]:0;return((parseInt(a[0],10)*60+parseFloat(b[0]))*1e3+parseInt(b[1],10))/1e3}return parseFloat(a).toSeconds()};String.prototype.secondsTo=function(a){return this.toSeconds().secondsTo(a)};Number.prototype.toSeconds=function(){return Math.round(this*1e3)/1e3};Number.prototype.secondsTo=function(a){var b=this;switch(a){case"ms":return Math.round(b*1e3);case"mm:ss":case"hh:mm:ss":case"hh:mm:ss.ms":var c="";if(a!="mm:ss"){c=Math.floor(b/3600);b=b-c*3600;c+=":"}var d=Math.floor(b/60);b=b-d*60;d=d<10?"0"+d:d;d+=":";var e=b;if(a=="hh:mm:ss"){e=Math.round(e)}e=e<10?"0"+e:e;return c+d+e}return b};(function(a){var b=function(a){var b={},c,d=[];for(c in a){if(a.hasOwnProperty(c)){d.push(c)}}d.sort(function(a,b){return a-b});for(c=0;c<d.length;c++){b[d[c]]=a[d[c]]}return b};$media.prototype.channels={timeline:{enabled:true}};$media.prototype.createChannel=function(a,b){if(!a||this.channels[a]){return false}if(typeof b!="object"){b={enabled:b?true:false}}this.channels[a]=b};$media.prototype.removeChannel=function(b){if(!b||!this.channels[b]){return false}if(a.isFunction(this.channels[b].remove)){a.proxy(this.channels[b].remove,this)(b)}delete this.channels[b]};$media.prototype.enableChannel=function(b,c){if(b==undefined){return this}c=c?true:false;var d=false;if(typeof b=="string"){if(this.channels[b]){if(this.channels[b].enabled!=c){if(c&&a.isFunction(this.channels[b].enable)){a.proxy(this.channels[b].enable,this)(b)}else if(!c&&a.isFunction(this.channels[b].disable)){a.proxy(this.channels[b].disable,this)(b)}this.channels[b].enabled=c;d=true}}}else if(a.isArray(b)){var e=b.length;for(var f=0;f<e;f++){if(this.channels[b[f]]){if(this.channels[b[f]].enabled!=c){if(c&&a.isFunction(this.channels[b[f]].enable)){a.proxy(this.channels[b[f]].enable,this)(b[f])}else if(!c&&a.isFunction(this.channels[b[f]].disable)){a.proxy(this.channels[b[f]].disable,this)(b[f])}this.channels[b[f]].enabled=c;d=true}}}}else if(typeof b=="object"){var e=b.length;for(var f=0;f<e;f++){if(this.channels[f]){var c=b[f]?true:false;if(this.channels[f].enabled!=c){if(c&&a.isFunction(this.channels[f].enable)){a.proxy(this.channels[f].enable,this)(f)}else if(!c&&a.isFunction(this.channels[f].disable)){a.proxy(this.channels[f].disable,this)(f)}this.channels[f].enabled=c;d=true}}}}if(d){this.refreshTimeline()}return this};$media.prototype.enabledChannel=function(a){if(!this.channels[a]||!this.channels[a].enabled){return false}return true};$media.prototype.timeline=function(b,c,d){if(!this.timeline_data){this.timeline_data={timeout:false,points:{},active_points:[],remaining_points:[],remaining_outpoints:[]};this.bind("mediaPlay mediaSeek",function(){this.executeTimeline()});this.seeking(function(a,b){this.executeTimelineOutPoints(b.secondsTo("ms"))})}var e=b;var f=c;var g=d;this.totalTime(function(){var b=[];if(a.isArray(e)){b=e;g=f}else if(typeof e=="object"){b=[e];g=f}else if(a.isFunction(f)){b[0]={time:e,fn:f}}g=g?g:"timeline";var c=b.length;if(!c){console.error("There is nothing to add to timeline");return this}for(var d=0;d<c;d++){if(a.isArray(b[d].time)){var h=[this.time(b[d].time[0]).secondsTo("ms"),this.time(b[d].time[1]).secondsTo("ms")]}else{var h=[this.time(b[d].time).secondsTo("ms")];h.push(h[0])}b[d].ms=h;var i=b[d].channel?b[d].channel:g;if(!this.channels[i]){console.error(i+" is not a valid channel");continue}if(this.timeline_data.points[i]==undefined){this.timeline_data.points[i]={}}if(this.timeline_data.points[i][h[0]]==undefined){this.timeline_data.points[i][h[0]]=[]}this.timeline_data.points[i][h[0]].push(b[d])}this.refreshTimeline()});return this};$media.prototype.refreshTimeline=function(){this.timeline_data.active_points=[];var a={};for(channel in this.channels){if(!this.channels[channel].enabled){continue}for(ms in this.timeline_data.points[channel]){if(a[ms]==undefined){a[ms]=[]}var c=this.timeline_data.points[channel][ms].length;for(var d=0;d<c;d++){var e=this.timeline_data.points[channel][ms][d];e.channel=channel;a[ms].push(e)}}}a=b(a);for(ms in a){var c=a[ms].length;for(var d=0;d<c;d++){this.timeline_data.active_points.push(a[ms][d])}}this.executeTimeline()};$media.prototype.getPoints=function(b,c,d,e,f){if(b==undefined){b=this.time()}var g=b.secondsTo("ms");var h=[];if(d){if(!a.isArray(d)){d=[d]}var f=this.timeline_data.active_points.length;for(var i=0;i<f;i++){if(a.inArray(this.timeline_data.active_points[i].channel,d)!=-1){h.push(this.timeline_data.active_points[i])}}}else{a.merge(h,this.timeline_data.active_points)}if(!h.length){return[]}var j=[];if(c){var f=h.length;for(var i=0;i<f;i++){if(g>h[i].ms[1]){j.push(h[i])}}j.reverse()}else{var f=h.length;for(var i=0;i<f;i++){if(g<h[i].ms[1]){j.push(h[i])}}}if(typeof e!="number"){return j}if(typeof f=="number"){return j.slice(e,e+f)}return j.slice(e)};$media.prototype.executeTimelineOutPoints=function(a){if(!this.timeline_data.remaining_outpoints.length){return}var b=this.timeline_data.remaining_outpoints.length;for(var c=0;c<b;c++){if(this.timeline_data.remaining_outpoints[c]&&(a<this.timeline_data.remaining_outpoints[c].ms[0]||a>this.timeline_data.remaining_outpoints[c].ms[1]||!this.channels[this.timeline_data.remaining_outpoints[c].channel].enabled)){this.executeTimelinePoint(this.timeline_data.remaining_outpoints[c],"fn_out");this.timeline_data.remaining_outpoints[c].waiting=false;this.timeline_data.remaining_outpoints.splice(c,1)}}};$media.prototype.executeTimelinePoint=function(b,c){if(!c){c="fn"}if(!a.isFunction(b[c])){console.error("There is not function to execute in timeline");return false}if(!a.isArray(b.data)){b.data=b.data==undefined?[]:[b.data]}if(!b.proxy){b.proxy=this}b[c].apply(b.proxy,a.merge([b.ms[0]],b.data))};$media.prototype.executeTimeline=function(){if(!this.timeline_data.active_points.length&&!this.timeline_data.remaining_points.length&&!this.timeline_data.remaining_outpoints.length){return}this.timeline_data.remaining_points=this.getPoints(this.time());if(!this.timeline_data.remaining_points.length&&!this.timeline_data.remaining_outpoints.length){return}this.timelineTimeout()};$media.prototype.timelineTimeout=function(){if(!this.timeline_data.remaining_points.length&&!this.timeline_data.remaining_outpoints.length){return}var b=this.time().secondsTo("ms");while(this.timeline_data.remaining_points&&this.timeline_data.remaining_points[0]&&this.timeline_data.remaining_points[0].ms[0]<=b){var c=this.timeline_data.remaining_points.shift();if(!c.waiting){this.executeTimelinePoint(c);if(a.isFunction(c.fn_out)){c.waiting=true;this.timeline_data.remaining_outpoints.push(c)}}}if(!this.timeline_data.remaining_points){return}this.executeTimelineOutPoints(b);if(this.element.paused||this.element.seeking||!this.timeline_data.remaining_points.length&&!this.timeline_data.remaining_outpoints.length){return}var d=0;if(this.timeline_data.remaining_points[0]){d=this.timeline_data.remaining_points[0].ms[0]}if(this.timeline_data.remaining_outpoints.length){var e=this.timeline_data.remaining_outpoints.length;for(var f=0;f<e;f++){if(!d||this.timeline_data.remaining_outpoints[f].ms[1]<d){d=this.timeline_data.remaining_outpoints[f].ms[1]}}}d=d-b+10;if(d<20){d=20}clearTimeout(this.timeline_data.timeout);this.timeline_data.timeout=setTimeout(a.proxy(this.timelineTimeout,this),d)}})(jQuery);