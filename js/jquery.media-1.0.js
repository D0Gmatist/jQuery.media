/**
 * $media jQuery plugin (v.1.0)
 *
 * 2011. Created by Oscar Otero (http://oscarotero.com)
 *
 * $media is released under the GNU Affero GPL version 3.
 * More information at http://www.gnu.org/licenses/agpl-3.0.html
 */

//Core
(function(b){var a=navigator.userAgent.toLowerCase();if(a.match(/(iphone|ipod|ipad)/)){a="ios"}else{a="browser"}window.$media=function(c){this.element=c;this.$element=b(c);if(this.$element.is("video")){this.type="video"}else{if(this.$element.is("audio")){this.type="audio"}}this.totalTime(function(){var d=this.source();this.fragment((d.substring(d.lastIndexOf("#")+1)).toLowerCase())})};$media.plugins={};$media.prototype.fragment=function(d){if(d==undefined){return this.$element.data("fragments")}var c={};if(typeof d=="string"){var e=d.split("&");var d={};b.each(e,function(f,g){g=g.split("=",2);d[g[0]]=g[1]})}if(typeof d!="object"){console.error("The specified fragment is not valid");return this}b.each(d,function(f,g){switch(f){case"t":if(typeof g=="string"){var h=g.match(/^(npt|smpte)/gi);var j=g.replace(/^(npt:|smpte[^:]+:)/,"").split(",",2);c.t={format:h?h[0]:"npt",start:j[0].toSeconds(),end:j[1].toSeconds()}}else{c.t=g;if(!c.t.format){c.t.format="npt"}}break;case"track":case"id":c.track=g;break;case"xywh":if(typeof g=="string"){var h=g.match(/^(pixel|percent)/gi);var i=g.replace(/^(pixel:|percent:)/,"").split(",",4);c.xywh={format:h?h[0]:"pixel",x:i[0],y:i[1],w:i[2],h:i[3]}}else{c.xywh=g;if(!c.xywh.format){c.xywh.format="pixel"}}break}});if(c.t){this.totalTime(function(){this.seek(c.t.start)})}this.$element.data("fragments",c);return this};$media.prototype.canPlay=function(d){if(!(this.element.canPlayType)){return false}if(d==undefined){d=this.source();d=(d.substring(d.lastIndexOf(".")+1)).toLowerCase().split("#",2)[0]}var c=d;if(/^[a-z0-9]+$/i.test(c)){c=this.mimeType(c)}switch(this.element.canPlayType(c)){case"probably":return 2;case"maybe":return 1}return 0};$media.prototype.mimeType=function(c){switch(c){case"mp4":case"acc":return this.type+"/mp4";case"ogg":case"ogv":return this.type+"/ogg";case"webm":return this.type+"/webm";case"mp3":return this.type+"/mpeg";case"wav":return this.type+"/wav"}};$media.prototype.sources=function(c,f){var d=this.$element;if(c==undefined){var g=[];if(d.attr("src")){g.push(d.attr("src"))}d.find("source").each(function(){g.push(b(this).attr("src"))});return g}d.find("source").remove();if(typeof c=="string"){d.attr("src",c)}else{if(!b.isArray(c)){c=[c]}d.removeAttr("src");var e=this;b.each(c,function(h,j){if(typeof j!="object"){j={src:j}}if(!j.type){var i=(j.src.substring(j.src.lastIndexOf(".")+1)).toLowerCase().split("#",2)[0];j.type=e.mimeType(i)}b("<source>",j).appendTo(d)})}if(f!==false){this.element.load()}this.totalTime(function(){var h=this.source();this.fragment((h.substring(h.lastIndexOf("#")+1)).toLowerCase())});return this};$media.prototype.source=function(){return this.element.currentSrc};$media.prototype.attr=function(c,d){if(c=="src"||c=="sources"){return this.sources(d)}if(d==undefined){return this.$element.attr(c)}this.$element.attr(c,d);return this};$media.prototype.prop=function(c,d){if(d==undefined){return this.$element.prop(c)}this.$element.prop(c,d);return this};$media.prototype.width=function(c){if(c===true){return this.element.videoWidth}if(c==undefined){return this.$element.width()}this.$element.width(c);return this};$media.prototype.height=function(c){if(c===true){return this.element.videoHeight}if(c==undefined){return this.$element.height()}this.$element.height(c);return this};$media.prototype.play=function(d,c){if(b.isFunction(d)){this.bind("mediaPlay",d,c)}else{if(this.element.paused){this.element.play()}}return this};$media.prototype.playing=function(d,c){if(b.isFunction(d)){this.bind("mediaPlaying",d,c);return this}return this.element.paused?false:true};$media.prototype.waiting=function(d,c){if(b.isFunction(d)){this.bind("mediaWaiting",d,c);return this}return(this.element.readyState>2)?false:true};$media.prototype.pause=function(d,c){if(b.isFunction(d)){this.bind("mediaPause",d,c)}else{if(!this.element.paused){this.element.pause()}}return this};$media.prototype.playPause=function(d,c){if(b.isFunction(d)){this.bind("mediaPlayPause",d,c)}else{if(this.element.paused){this.play()}else{this.pause()}this.trigger("mediaPlayPause",[this.time(),this.element.paused])}return this};$media.prototype.stop=function(d,c){if(b.isFunction(d)){this.bind("mediaStop",d,c)}else{this.pause().reload();this.trigger("mediaStop",[this.time()])}return this};$media.prototype.end=function(d,c){if(b.isFunction(d)){this.bind("mediaEnd",d,c)}else{this.pause().seek(this.element.duration)}return this};$media.prototype.seek=function(d,c){if(b.isFunction(d)){this.bind("mediaSeek",d,c)}else{var e=this.seekPoint(d)||this.time(d);if(this.element.currentTime!=e){this.element.currentTime=e}}return this};$media.prototype.seekPoint=function(d,e){var c=this.$element.data("seek_points")||{};if(e==undefined){return c[d]}c[d]=this.time(e);this.$element.data("seek_points",c);return this};$media.prototype.seeking=function(d,c){if(b.isFunction(d)){this.bind("mediaSeeking",d,c);return this}return this.element.seeking};$media.prototype.volume=function(d,c){if(a=="ios"){return this}if(d==undefined){return Math.round(this.element.volume*100)}if(b.isFunction(d)){this.bind("mediaVolume",d,c)}else{this.element.volume=parseInt(d)/100}return this};$media.prototype.changingVolume=function(d,c){if(b.isFunction(d)){this.bind("mediaChangingVolume",d,c)}return this};$media.prototype.mute=function(d,c){if(a=="ios"){return this}if(b.isFunction(d)){this.bind("mediaMute",d,c)}else{if(typeof d=="boolean"){this.element.muted=d}else{this.element.muted=this.element.muted?false:true}this.trigger("mediaMute",[this.element.muted])}return this};$media.prototype.bind=function(c,i,f){var k=this.$element.data("events");k=(k&&k[c])?true:false;if(f){this.$element.one(c,b.proxy(i,this))}else{this.$element.bind(c,b.proxy(i,this))}if(k){return this}var g=this;switch(c){case"mediaEnd":this.bind("ended",function(){this.trigger("mediaEnd",[this.time()])});break;case"mediaPause":this.bind("pause",function(){this.trigger("mediaPause",[this.time()])});break;case"mediaWaiting":this.bind("waiting",function(){this.trigger("mediaWaiting",[this.time()])});break;case"mediaPlay":this.bind("play",function(){this.trigger("mediaPlay",[this.time()])});break;case"mediaPlaying":this.bind("timeupdate",function(){if(!this.element.paused){this.trigger("mediaPlaying",[this.time()])}});break;case"mediaSeek":case"mediaSeeking":var j;var d=function(){g.trigger("mediaSeek",[g.time()])};this.bind("seeked seeking",function(){clearTimeout(j);j=setTimeout(d,500);this.trigger("mediaSeeking",[this.time()])});break;case"mediaVolume":case"mediaChangingVolume":var e;var h=function(){g.trigger("mediaVolume",[g.volume()])};this.bind("volumechange",function(){clearTimeout(e);e=setTimeout(h,500);this.trigger("mediaChangingVolume",[this.volume()])});break}return this};$media.prototype.trigger=function(c,d){this.$element.trigger(c,d);return this};$media.prototype.time=function(d){if(d==undefined){return this.element.currentTime.toSeconds()}if(isNaN(parseInt(d))){return 0}d=""+d;var e=0;if(d.indexOf("+")===0||d.indexOf("-")===0){var c=d.substr(1).toSeconds();if(d.indexOf("-")===0){c=-c}if(d.indexOf("%")==-1){e=c+this.element.currentTime.toSeconds()}else{e=Math.round((this.totalTime()/100)*parseInt(c))+this.element.currentTime.toSeconds()}}else{if(d.indexOf("%")!=-1){e=Math.round((this.totalTime()/100)*d.toSeconds())}else{e=d.toSeconds()}}if(e<0){e=0}else{if(e>this.totalTime()){e=this.totalTime()}}return e};$media.prototype.totalTime=function(c){if(!b.isFunction(c)){return this.element.duration.toSeconds()}return this.ready(1,function(){b.proxy(c,this)(this.element.duration.toSeconds())})};$media.prototype.ready=function(g,e){if(typeof g!="number"){e=g;g=3}if(!b.isFunction(e)){return(this.element.readyState<g)?false:true}if(this.element.readyState>=g){b.proxy(e,this)()}else{var f=this;var d=function(){if(f.element.readyState>=g){clearInterval(c);b.proxy(e,f)()}};var c=setInterval(b.proxy(d,f),13)}return this};$media.prototype.reload=function(){this.sources(this.sources());return this};$media.prototype.extend=function(d,e){if(typeof d!="object"){var c=d;d={};d[c]=e}b.extend(this,d)};$media.extend=function(d,e){if(typeof d!="object"){var c=d;d={};d[c]=e}b.each(d,function(g,f){$media.prototype[g]=f})};$media.prototype.addPlugin=function(e,d){var c=e;if(typeof c!="object"){c={};c[e]=d}var f=this;b.each(c,function(h,g){if(!$media.plugins[h]){console.error('The plugin "'+h+'" is not registered');return false}f[h]=new $media.plugins[h](f,g)});return this};jQuery.media=function(c){c=b(c);if(!c.is("video, audio")){c=c.find("video, audio")}return new $media(c.get(0))}})(jQuery);String.prototype.toSeconds=function(){var b=this;if(/^([0-9]{1,2}:)?[0-9]{1,2}:[0-9]{1,2}(\.[0-9]+)?(,[0-9]+)?$/.test(b)){b=b.split(":",3);if(b.length==3){var a=b[2].split(",",2);a[1]=a[1]?a[1]:0;return((((parseInt(b[0],10)*3600)+(parseInt(b[1],10)*60)+parseFloat(a[0]))*1000)+parseInt(a[1],10))/1000}var a=b[1].split(",",1);a[1]=a[1]?a[1]:0;return((((parseInt(b[0],10)*60)+parseFloat(a[0]))*1000)+parseInt(a[1],10))/1000}return parseFloat(b).toSeconds()};String.prototype.secondsTo=function(a){return this.toSeconds().secondsTo(a)};Number.prototype.toSeconds=function(){return Math.round(this*1000)/1000};Number.prototype.secondsTo=function(e){var c=this;switch(e){case"ms":return Math.round(c*1000);case"mm:ss":case"hh:mm:ss":case"hh:mm:ss.ms":var b="";if(e!="mm:ss"){b=Math.floor(c/3600);c=c-(b*3600);b+=":"}var d=Math.floor(c/60);c=c-(d*60);d=(d<10)?("0"+d):d;d+=":";var a=c;if(e=="hh:mm:ss"){a=Math.round(a)}a=(a<10)?("0"+a):a;return b+d+a}return c};

//Timeline
(function(b){var a=function(f){var c={},d,e=[];for(d in f){if(f.hasOwnProperty(d)){e.push(d)}}e.sort(function(h,g){return h-g});for(d=0;d<e.length;d++){c[e[d]]=f[e[d]]}return c};$media.prototype.channels={timeline:{enabled:true}};$media.prototype.createChannel=function(d,c){if(!d||this.channels[d]){return false}if(typeof c!="object"){c={enabled:c?true:false}}this.channels[d]=c};$media.prototype.removeChannel=function(c){if(!c||!this.channels[c]){return false}if(b.isFunction(this.channels[c].remove)){b.proxy(this.channels[c].remove,this)(c)}delete this.channels[c]};$media.prototype.enableChannel=function(e,c){if(e==undefined){return this}c=c?true:false;var d=false;if(typeof e=="string"){if(this.channels[e]){if(this.channels[e].enabled!=c){if(c&&b.isFunction(this.channels[e].enable)){b.proxy(this.channels[e].enable,this)(e)}else{if(!c&&b.isFunction(this.channels[e].disable)){b.proxy(this.channels[e].disable,this)(e)}}this.channels[e].enabled=c;d=true}}}else{if(b.isArray(e)){for(k in e){if(this.channels[e[k]]){if(this.channels[e[k]].enabled!=c){if(c&&b.isFunction(this.channels[e[k]].enable)){b.proxy(this.channels[e[k]].enable,this)(e[k])}else{if(!c&&b.isFunction(this.channels[e[k]].disable)){b.proxy(this.channels[e[k]].disable,this)(e[k])}}this.channels[e[k]].enabled=c;d=true}}}}else{if(typeof e=="object"){for(k in e){if(this.channels[k]){var c=e[k]?true:false;if(this.channels[k].enabled!=c){if(c&&b.isFunction(this.channels[k].enable)){b.proxy(this.channels[k].enable,this)(k)}else{if(!c&&b.isFunction(this.channels[k].disable)){b.proxy(this.channels[k].disable,this)(k)}}this.channels[k].enabled=c;d=true}}}}}}if(d){this.refreshTimeline()}return this};$media.prototype.enabledChannel=function(c){if(!this.channels[c]||!this.channels[c].enabled){return false}return true};$media.prototype.timeline=function(h,e,f){if(!this.timeline_data){this.timeline_data={timeout:false,points:{},active_points:[],remaining_points:[],remaining_outpoints:[]};this.bind("mediaPlay mediaSeek",function(){this.executeTimeline()});this.seeking(function(i,j){this.executeTimelineOutPoints(j*1000)})}var d=h;var c=e;var g=f;this.totalTime(function(){var m=[];if(b.isArray(d)){m=d;g=c}else{if(typeof d=="object"){m=[d];g=c}else{if(b.isFunction(c)){m[0]={time:d,fn:c}}}}g=g?g:"timeline";var q=m.length;if(!q){console.error("There is nothing to add to timeline");return this}for(var l=0;l<q;l++){if(b.isArray(m[l].time)){var j=[Math.round(this.time(m[l].time[0])*1000),Math.round(this.time(m[l].time[1])*1000)]}else{var j=[Math.round(this.time(m[l].time)*1000)];j.push(j[0])}m[l].ms=j;var o=m[l].channel?m[l].channel:g;if(!this.channels[o]){console.error(o+" is not a valid channel");continue}if(this.timeline_data.points[o]==undefined){this.timeline_data.points[o]={}}if(this.timeline_data.points[o][j[0]]==undefined){this.timeline_data.points[o][j[0]]=[]}this.timeline_data.points[o][j[0]].push(m[l])}this.refreshTimeline()});return this};$media.prototype.refreshTimeline=function(){this.timeline_data.active_points=[];var d={};for(channel in this.channels){if(!this.channels[channel].enabled){continue}for(ms in this.timeline_data.points[channel]){if(d[ms]==undefined){d[ms]=[]}for(p in this.timeline_data.points[channel][ms]){var c=this.timeline_data.points[channel][ms][p];c.channel=channel;d[ms].push(c)}}}d=a(d);for(ms in d){for(p in d[ms]){this.timeline_data.active_points.push(d[ms][p])}}this.executeTimeline()};$media.prototype.getPoints=function(f,e,c,i,g){if(f==undefined){f=this.time()}var d=Math.round(f*1000);var h=[];if(c){if(!b.isArray(c)){c=[c]}for(k in this.timeline_data.active_points){if(b.inArray(this.timeline_data.active_points[k].channel,c)!=-1){h.push(this.timeline_data.active_points[k])}}}else{b.merge(h,this.timeline_data.active_points)}if(!h.length){return[]}var j=[];if(e){for(k in h){if(d>h[k].ms[1]){j.push(h[k])}}j.reverse()}else{for(k in h){if(d<h[k].ms[1]){j.push(h[k])}}}if(typeof i!="number"){return j}if(typeof g=="number"){return j.slice(i,i+g)}return j.slice(i)};$media.prototype.executeTimelineOutPoints=function(c){if(!this.timeline_data.remaining_outpoints.length){return}for(s in this.timeline_data.remaining_outpoints){if(c<this.timeline_data.remaining_outpoints[s].ms[0]||c>this.timeline_data.remaining_outpoints[s].ms[1]||!this.channels[this.timeline_data.remaining_outpoints[s].channel].enabled){this.executeTimelinePoint(this.timeline_data.remaining_outpoints[s],"fn_out");this.timeline_data.remaining_outpoints[s].waiting=false;this.timeline_data.remaining_outpoints.splice(s,1)}}};$media.prototype.executeTimelinePoint=function(c,d){if(!d){d="fn"}if(!b.isFunction(c[d])){console.error("There is not function to execute in timeline");return false}if(!b.isArray(c.data)){c.data=(c.data==undefined)?[]:[c.data]}if(!c.proxy){c.proxy=this}c[d].apply(c.proxy,b.merge([c.ms[0]],c.data))};$media.prototype.executeTimeline=function(){if(!this.timeline_data.active_points.length&&!this.timeline_data.remaining_points.length&&!this.timeline_data.remaining_outpoints.length){return}this.timeline_data.remaining_points=this.getPoints(this.time());if(!this.timeline_data.remaining_points.length&&!this.timeline_data.remaining_outpoints.length){return}this.timelineTimeout()};$media.prototype.timelineTimeout=function(){if(!this.timeline_data.remaining_points.length&&!this.timeline_data.remaining_outpoints.length){return}var d=this.time()*1000;while(this.timeline_data.remaining_points[0]&&this.timeline_data.remaining_points[0].ms[0]<=d){var c=this.timeline_data.remaining_points.shift();if(!c.waiting){this.executeTimelinePoint(c);if(b.isFunction(c.fn_out)){c.waiting=true;this.timeline_data.remaining_outpoints.push(c)}}}this.executeTimelineOutPoints(d);if(this.element.paused||this.element.seeking||(!this.timeline_data.remaining_points.length&&!this.timeline_data.remaining_outpoints.length)){return}var e=0;if(this.timeline_data.remaining_points[0]){e=this.timeline_data.remaining_points[0].ms[0]}if(this.timeline_data.remaining_outpoints.length){for(n in this.timeline_data.remaining_outpoints){if(!e||this.timeline_data.remaining_outpoints[n].ms[1]<e){e=this.timeline_data.remaining_outpoints[n].ms[1]}}}e=(e-d)+10;if(e<20){e=20}clearTimeout(this.timeline_data.timeout);this.timeline_data.timeout=setTimeout(b.proxy(this.timelineTimeout,this),e)}})(jQuery);